<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <title>OAuth Test - Login with Google</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        margin: 24px;
      }
      .box {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px 20px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 12px;
      }
      button {
        padding: 10px 14px;
        border-radius: 8px;
        background: #1a73e8;
        color: #fff;
        border: none;
        cursor: pointer;
      }
      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      code {
        background: #f3f4f6;
        padding: 2px 6px;
        border-radius: 6px;
      }
      .row {
        margin: 10px 0;
      }
      .muted {
        color: #6b7280;
        font-size: 14px;
      }
      .warn {
        color: #b45309;
      }
      .ok {
        color: #059669;
      }
      pre {
        background: #0b1021;
        color: #c7d2fe;
        padding: 12px;
        border-radius: 8px;
        overflow: auto;
      }
      a {
        color: #1a73e8;
      }
    </style>
  </head>
  <body>
    <div class="box">
      <h1>Test đăng nhập Google</h1>
      <div id="status" class="muted">Đang tải cấu hình...</div>

      <div class="row">
        <div>clientId: <code id="clientId">(loading)</code></div>
        <div>redirectUri: <code id="redirectUri">(loading)</code></div>
      </div>

      <div class="row">
        <button id="btnLogin" disabled>Login with Google</button>
        <span id="hint" class="muted">Nhấn để chuyển tới Google, sau đó quay lại callback</span>
      </div>

      <div class="row">
        <label
          ><input type="checkbox" id="cbManual" /> Manual exchange (không tự đổi code ở trang
          callback)</label
        >
      </div>

      <details class="row">
        <summary>Xem trước authorization URL</summary>
        <pre id="authUrl"></pre>
      </details>

      <p class="muted" id="redirectNote">
        Lưu ý: Nếu bạn muốn dùng trang callback này, hãy đặt <code>GOOGLE_REDIRECT_URI</code> =
        <code>(đang tính...)</code> và thêm URI này vào Google Cloud Console.
      </p>
    </div>

    <script>
      const s = document.getElementById("status");
      const cid = document.getElementById("clientId");
      const ruri = document.getElementById("redirectUri");
      const btn = document.getElementById("btnLogin");
      const pre = document.getElementById("authUrl");

      function buildAuthUrl(cfg, state, pkce) {
        const params = new URLSearchParams({
          client_id: cfg.clientId,
          redirect_uri: cfg.redirectUri,
          response_type: "code",
          scope: cfg.scope || "openid email profile",
          include_granted_scopes: "true",
          access_type: "online",
        });
        if (state) params.set("state", state);
        if (pkce && pkce.challenge) {
          params.set("code_challenge_method", "S256");
          params.set("code_challenge", pkce.challenge);
        }
        return `${cfg.authEndpoint || "https://accounts.google.com/o/oauth2/v2/auth"}?${params.toString()}`;
      }

      async function sha256(buffer) {
        const digest = await crypto.subtle.digest("SHA-256", buffer);
        return new Uint8Array(digest);
      }
      function base64Url(bytes) {
        let str = btoa(String.fromCharCode.apply(null, Array.from(bytes)));
        return str.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
      }

      async function main() {
        try {
          const res = await fetch("/api/v1/auth/config");
          const cfg = await res.json();
          cid.textContent = cfg.clientId || "(empty)";
          ruri.textContent = cfg.redirectUri || "(empty)";
          // Update redirect note dynamically based on current origin
          try {
            const note = document.getElementById("redirectNote");
            const origin = window.location.origin;
            const recommended = origin + "/oauth/google/callback";
            note.innerHTML =
              "Lưu ý: Nếu bạn muốn dùng trang callback này, hãy đặt <code>GOOGLE_REDIRECT_URI</code> = " +
              "<code>" +
              recommended +
              "</code> và thêm URI này vào Google Cloud Console.";
          } catch {}
          // Get server-issued state and set cookie for CSRF protection
          const manual = document.getElementById("cbManual").checked;
          const stRes = await fetch(`/api/v1/auth/state${manual ? "?manual=1" : ""}`);
          const st = await stRes.json();
          const state = st.state;
          // Generate PKCE if required
          let pkce = null;
          try {
            if (cfg.pkceRequired) {
              const rand = crypto.getRandomValues(new Uint8Array(32));
              const verifier = base64Url(rand);
              sessionStorage.setItem("pkce_verifier", verifier);
              const enc = new TextEncoder().encode(verifier);
              const hash = await sha256(enc);
              pkce = { challenge: base64Url(hash), verifier };
            }
          } catch {}
          let url = buildAuthUrl(cfg, state, pkce);
          pre.textContent = url;
          if (!cfg.clientId || !cfg.redirectUri) {
            s.textContent = "Thiếu clientId/redirectUri. Hãy cấu hình .env và restart backend.";
            s.className = "warn";
            btn.disabled = true;
            return;
          }
          btn.disabled = false;
          btn.onclick = () => {
            window.location.href = url;
          };
          s.textContent = "Sẵn sàng. Nhấn Login with Google để bắt đầu.";
          s.className = "ok";

          // Toggle manual: re-fetch state so cookie stays in sync; refresh PKCE
          const cb = document.getElementById("cbManual");
          cb.addEventListener("change", async () => {
            try {
              const st2Res = await fetch(`/api/v1/auth/state${cb.checked ? "?manual=1" : ""}`);
              const st2 = await st2Res.json();
              const state2 = st2.state;
              let pkce2 = null;
              try {
                if (cfg.pkceRequired) {
                  const rand2 = crypto.getRandomValues(new Uint8Array(32));
                  const verifier2 = base64Url(rand2);
                  sessionStorage.setItem("pkce_verifier", verifier2);
                  const enc2 = new TextEncoder().encode(verifier2);
                  const hash2 = await sha256(enc2);
                  pkce2 = { challenge: base64Url(hash2), verifier: verifier2 };
                }
              } catch {}
              url = buildAuthUrl(cfg, state2, pkce2);
              pre.textContent = url;
            } catch {}
          });
        } catch (e) {
          s.textContent = "Không tải được cấu hình: " + (e?.message || e);
          s.className = "warn";
        }
      }

      main();
    </script>
  </body>
</html>
