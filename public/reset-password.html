<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reset Password</title>
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, "Apple Color Emoji", "Segoe UI Emoji";
        margin: 0;
        padding: 0;
        background: #f6f7f9;
      }
      .wrap {
        max-width: 480px;
        margin: 8vh auto;
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      h1 {
        margin: 0 0 8px;
        font-size: 22px;
      }
      p {
        margin: 0 0 16px;
        color: #555;
      }
      .field {
        margin-bottom: 12px;
      }
      label {
        display: block;
        font-size: 14px;
        margin-bottom: 4px;
        color: #333;
      }
      input[type="password"] {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d0d7de;
        border-radius: 8px;
        font-size: 14px;
      }
      button {
        padding: 10px 14px;
        background: #2563eb;
        color: #fff;
        border: 0;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .status {
        margin: 8px 0 16px;
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 14px;
        display: none;
      }
      .status.ok {
        background: #ecfdf5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }
      .status.err {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }
      .muted {
        color: #6b7280;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Reset your password</h1>
      <p class="muted">Enter a new password for your account.</p>

      <div id="status" class="status"></div>

      <form id="form">
        <div class="field">
          <label for="password">New password</label>
          <input
            id="password"
            name="password"
            type="password"
            minlength="8"
            maxlength="128"
            required
          />
        </div>
        <div class="field">
          <label for="confirm">Confirm new password</label>
          <input
            id="confirm"
            name="confirm"
            type="password"
            minlength="8"
            maxlength="128"
            required
          />
        </div>
        <button id="submit" type="submit">Reset password</button>
      </form>

      <p class="muted" id="hint"></p>
    </div>

    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const token = params.get("token");
        const statusEl = document.getElementById("status");
        const formEl = document.getElementById("form");
        const submitBtn = document.getElementById("submit");
        const hintEl = document.getElementById("hint");

        function show(msg, ok) {
          statusEl.textContent = msg;
          statusEl.className = "status " + (ok ? "ok" : "err");
          statusEl.style.display = "block";
        }

        if (!token) {
          show(
            "Missing token in URL. Please use the link from your email.",
            false
          );
          formEl.style.display = "none";
          return;
        }

        formEl.addEventListener("submit", async function (e) {
          e.preventDefault();
          const password = document.getElementById("password").value;
          const confirm = document.getElementById("confirm").value;

          if (password !== confirm) {
            show("Passwords do not match.", false);
            return;
          }

          submitBtn.disabled = true;
          show("Submitting...", true);

          try {
            const res = await fetch("/api/v1/auth/reset-password", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token, newPassword: password }),
            });
            const data = await res.json().catch(() => ({}));

            if (res.ok) {
              show(
                data.message || "Password has been reset. You can now log in.",
                true
              );
              formEl.reset();
              formEl.style.display = "none";
              hintEl.textContent = "";
            } else {
              show(data.message || "Failed to reset password.", false);
              const details = data && data.code ? " (" + data.code + ")" : "";
              hintEl.textContent =
                data && data.details ? JSON.stringify(data.details) : details;
            }
          } catch (err) {
            show("Network error. Please try again.", false);
          } finally {
            submitBtn.disabled = false;
          }
        });
      })();
    </script>
  </body>
</html>
