# K·∫ø ho·∫°ch Ho√†n thi·ªán Backend Learinal

**Phi√™n b·∫£n:** 1.0  
**Ng√†y t·∫°o:** 28/10/2025  
**Ph·∫°m vi:** Ho√†n thi·ªán to√†n b·ªô backend MVP v0.1 theo SRS/SDD/OpenAPI

---

## üìã M·ª•c l·ª•c

1. [T·ªïng quan t√¨nh tr·∫°ng hi·ªán t·∫°i](#1-t·ªïng-quan-t√¨nh-tr·∫°ng-hi·ªán-t·∫°i)
2. [C√°c c√¥ng vi·ªác c·∫ßn ho√†n th√†nh](#2-c√°c-c√¥ng-vi·ªác-c·∫ßn-ho√†n-th√†nh)
3. [K·∫ø ho·∫°ch chi ti·∫øt theo module](#3-k·∫ø-ho·∫°ch-chi-ti·∫øt-theo-module)
4. [L·ªô tr√¨nh tri·ªÉn khai 4 tu·∫ßn](#4-l·ªô-tr√¨nh-tri·ªÉn-khai-4-tu·∫ßn)
5. [Ti√™u ch√≠ nghi·ªám thu (DoD)](#5-ti√™u-ch√≠-nghi·ªám-thu-dod)
6. [R·ªßi ro v√† gi·∫£i ph√°p](#6-r·ªßi-ro-v√†-gi·∫£i-ph√°p)
7. [Checklist t·ªïng h·ª£p](#7-checklist-t·ªïng-h·ª£p)

---

## 1. T·ªïng quan t√¨nh tr·∫°ng hi·ªán t·∫°i

### ‚úÖ ƒê√£ ho√†n th√†nh

**H·∫° t·∫ßng c∆° b·∫£n:**
- ‚úÖ C·∫•u tr√∫c th∆∞ m·ª•c theo ki·∫øn tr√∫c layered (Controller ‚Üí Service ‚Üí Repository)
- ‚úÖ Mongoose models cho t·∫•t c·∫£ collections (users, subjects, documents, questionSets, quizAttempts, validationRequests, commissionRecords, subscriptionPlans, userSubscriptions, notifications)
- ‚úÖ C·∫•u h√¨nh m√¥i tr∆∞·ªùng (config/env.js, mongo.js, redis.js, llm.js, email.js, storage.js, stripe.js, oauth.js)
- ‚úÖ Logger (Pino)
- ‚úÖ Routes structure cho t·∫•t c·∫£ resources

**Adapters (ƒë√£ c√≥ skeleton):**
- ‚úÖ LLMClient (Gemini API v·ªõi retry/backoff)
- ‚úÖ EmailClient
- ‚úÖ StorageClient
- ‚úÖ OAuthClient
- ‚úÖ EventBus/Queue

**Middleware:**
- ‚úÖ authenticateJWT
- ‚úÖ authorizeRole
- ‚úÖ errorHandler
- ‚úÖ errorFormatter
- ‚úÖ requestId
- ‚úÖ rateLimit
- ‚úÖ etag
- ‚úÖ idempotencyKey
- ‚úÖ inputValidation

**Repositories:**
- ‚úÖ T·∫•t c·∫£ repository files ƒë√£ t·∫°o (users, subjects, documents, questionSets, quizAttempts, validationRequests, commissionRecords, subscriptionPlans, userSubscriptions, notifications)

**Services:**
- ‚úÖ T·∫•t c·∫£ service files ƒë√£ t·∫°o

**Controllers:**
- ‚úÖ T·∫•t c·∫£ controller files ƒë√£ t·∫°o

### ‚ö†Ô∏è C·∫ßn ho√†n thi·ªán

**Implementation ch∆∞a ƒë·∫ßy ƒë·ªß:**
- ‚ö†Ô∏è Controllers: nhi·ªÅu endpoint ch·ªâ c√≥ skeleton, ch∆∞a implement logic ƒë·∫ßy ƒë·ªß
- ‚ö†Ô∏è Services: business logic ch∆∞a ho√†n thi·ªán, thi·∫øu validation rules
- ‚ö†Ô∏è Repositories: c√°c ph∆∞∆°ng th·ª©c CRUD c∆° b·∫£n ch∆∞a implement h·∫øt
- ‚ö†Ô∏è Jobs/Workers: ch∆∞a implement ho√†n ch·ªânh c√°c background jobs
- ‚ö†Ô∏è Integration gi·ªØa c√°c modules ch∆∞a ƒë∆∞·ª£c test
- ‚ö†Ô∏è Tests: ch·ªâ c√≥ smoke.placeholder.js

**Ch·ª©c nƒÉng ch∆∞a ho√†n thi·ªán:**
- ‚ö†Ô∏è OAuth 2.0 flow (Google) - ch∆∞a integrate th·∫≠t
- ‚ö†Ô∏è LLM integration - c·∫ßn test v√† optimize prompts
- ‚ö†Ô∏è File upload/processing pipeline
- ‚ö†Ô∏è Question generation workflow
- ‚ö†Ô∏è Scoring algorithm v·ªõi tr·ªçng s·ªë ƒë·ªô kh√≥
- ‚ö†Ô∏è Validation request workflow (assign Expert, notifications)
- ‚ö†Ô∏è Commission calculation
- ‚ö†Ô∏è Subscription/Payment flow
- ‚ö†Ô∏è Stripe webhook handler
- ‚ö†Ô∏è Email templates v√† notification system

---

## 2. C√°c c√¥ng vi·ªác c·∫ßn ho√†n th√†nh

### A. Core Features (∆Øu ti√™n cao)

#### A1. Authentication & Authorization
- [ ] Implement OAuth 2.0 flow v·ªõi Google (exchange code ‚Üí tokens)
- [ ] JWT refresh token mechanism
- [ ] Token validation v√† revocation
- [ ] Role-based access control (Learner/Expert/Admin)
- [ ] Ownership checks cho t√†i nguy√™n
- [ ] Session management

#### A2. User Management
- [ ] CRUD operations ho√†n ch·ªânh cho users
- [ ] Profile update v·ªõi ETag support
- [ ] Subscription status tracking
- [ ] Admin user management endpoints

#### A3. Document Management
- [ ] Upload flow (multipart ho·∫∑c pre-signed URL)
- [ ] File validation (size ‚â§20MB, types: .pdf/.docx/.txt)
- [ ] Status workflow: Uploading ‚Üí Processing ‚Üí Completed/Error
- [ ] Text extraction job (worker)
- [ ] Summary generation (short/full) job
- [ ] Document retrieval v·ªõi authorization

#### A4. Question Set Management
- [ ] Generate questions t·ª´ document v·ªõi LLM
- [ ] Prompt engineering cho Gemini API
- [ ] Parse v√† validate c√¢u h·ªèi MCQ
- [ ] Enforce difficultyLevel (Bi·∫øt/Hi·ªÉu/V·∫≠n d·ª•ng/V·∫≠n d·ª•ng cao)
- [ ] CRUD operations v·ªõi ownership check
- [ ] Share link generation (unique URL)
- [ ] Idempotency cho generation requests

#### A5. Quiz Attempts & Scoring
- [ ] Start quiz attempt
- [ ] Submit answers
- [ ] Scoring algorithm v·ªõi tr·ªçng s·ªë theo ƒë·ªô kh√≥:
  ```
  Bi·∫øt: 1.0
  Hi·ªÉu: 1.5
  V·∫≠n d·ª•ng: 2.0
  V·∫≠n d·ª•ng cao: 2.5
  ```
- [ ] Calculate percentage score
- [ ] Store attempt history
- [ ] Commission trigger khi complete

#### A6. Validation Workflow
- [ ] Create validation request
- [ ] Assign to Expert (manual ho·∫∑c auto)
- [ ] Expert review interface
- [ ] Update question set sau review
- [ ] Notifications cho Learner/Expert
- [ ] Status tracking (PendingAssignment/Assigned/Completed/Rejected)

#### A7. Notifications
- [ ] In-app notifications
- [ ] Email notifications via SendGrid/SES
- [ ] Email templates (review.assigned, review.completed, welcome, etc.)
- [ ] Mark as read functionality
- [ ] Pagination v√† filtering

#### A8. Subscriptions & Payments
- [ ] List subscription plans
- [ ] Create subscription (PendingPayment)
- [ ] Stripe payment integration
- [ ] Webhook handler cho payment events
- [ ] Entitlements enforcement
- [ ] Renewal tracking

#### A9. Commission System
- [ ] Calculate commission cho Expert reviews
- [ ] Record commission khi quiz completed
- [ ] Status tracking (Pending/Paid)
- [ ] Commission reports for Experts

### B. Infrastructure & Quality (∆Øu ti√™n trung b√¨nh)

#### B1. Background Jobs
- [ ] document.ingestion (text extraction)
- [ ] content.summary (summarize documents)
- [ ] questions.generate (LLM question generation)
- [ ] notifications.email (send email)
- [ ] review.assigned (notify Expert)
- [ ] review.completed (notify Learner)
- [ ] Retry logic v·ªõi exponential backoff
- [ ] Dead letter queue handling

#### B2. Data Validation & Constraints
- [ ] Input validation v·ªõi Joi schemas
- [ ] Mongoose schema validators
- [ ] Indexes optimization
- [ ] Unique constraints (email, sharedUrl, validationRequest per set)
- [ ] Partial indexes cho validationRequests

#### B3. Error Handling & Logging
- [ ] Standardized error responses `{ code, message, details }`
- [ ] Error mapping (Mongoose ‚Üí HTTP)
- [ ] Request correlation (requestId)
- [ ] Structured logging v·ªõi userId/action
- [ ] Rate limit headers

#### B4. Testing
- [ ] Unit tests cho services (‚â•85% coverage)
- [ ] Integration tests cho repositories
- [ ] API contract tests (OpenAPI compliance)
- [ ] E2E tests cho critical flows
- [ ] Mock external services (LLM, Email, Storage)

#### B5. Security
- [ ] Input sanitization
- [ ] SQL/NoSQL injection prevention
- [ ] CORS configuration
- [ ] Helmet security headers
- [ ] Secrets management (env vars)
- [ ] File upload security (MIME validation, virus scan)

### C. Nice-to-Have (∆Øu ti√™n th·∫•p)

- [ ] API documentation (Swagger UI)
- [ ] Rate limiting per user/role
- [ ] Caching layer (Redis)
- [ ] Monitoring & metrics (Prometheus/Grafana)
- [ ] CI/CD pipeline
- [ ] Docker containerization
- [ ] Health checks n√¢ng cao (DB/Queue/LLM status)

---

## 3. K·∫ø ho·∫°ch chi ti·∫øt theo module

### Module 1: Auth & Users (BE1)

**Owner:** Backend Developer 1  
**Timeline:** Tu·∫ßn 1-2

**Endpoints:**
- POST `/auth/exchange` - Exchange OAuth code for JWT
- POST `/auth/refresh` - Refresh access token
- GET `/users/me` - Get current user profile
- PATCH `/users/me` - Update profile (v·ªõi ETag)
- GET `/admin/users` - List all users (Admin only)

**Tasks:**
1. ‚úÖ C·∫•u tr√∫c routes/controllers/services ƒë√£ c√≥
2. ‚ö†Ô∏è Implement OAuth 2.0 flow:
   - T√≠ch h·ª£p Google OAuth client
   - Exchange authorization code ‚Üí Google tokens
   - Verify ID token
   - Create/update user record
   - Generate JWT access + refresh tokens
3. ‚ö†Ô∏è Implement refresh token flow:
   - Validate refresh token
   - Generate new access token
   - Rotate refresh token
4. ‚ö†Ô∏è Implement user profile:
   - GET v·ªõi authorization
   - PATCH v·ªõi ETag + ownership check
   - Validate input (fullName, email format)
5. ‚ö†Ô∏è Admin endpoints:
   - List users v·ªõi pagination
   - Filter by role/status
   - Search by email
6. ‚ö†Ô∏è Tests:
   - Unit tests cho auth service
   - Integration tests cho OAuth flow
   - Contract tests cho endpoints

**Acceptance Criteria:**
- [ ] OAuth flow ho·∫°t ƒë·ªông v·ªõi Google (dev + prod)
- [ ] JWT tokens ƒë∆∞·ª£c validate ƒë√∫ng
- [ ] Refresh token mechanism ho·∫°t ƒë·ªông
- [ ] ETag prevents concurrent updates
- [ ] RBAC enforced (Admin role required)
- [ ] Tests coverage ‚â•90%
- [ ] Compliant v·ªõi OpenAPI spec

---

### Module 2: Subjects & Documents (BE2)

**Owner:** Backend Developer 2  
**Timeline:** Tu·∫ßn 2-3

**Endpoints:**
- GET/POST `/subjects` - List/Create subjects
- GET/PATCH/DELETE `/subjects/{id}` - Subject operations
- POST `/documents` - Upload document
- GET `/documents/{id}` - Get document info
- GET `/documents/{id}/summary` - Get document summary

**Tasks:**
1. ‚úÖ C·∫•u tr√∫c c∆° b·∫£n ƒë√£ c√≥
2. ‚ö†Ô∏è Implement Subjects CRUD:
   - Create v·ªõi userId ownership
   - List v·ªõi pagination, filter by userId
   - Update/Delete v·ªõi ownership check
   - Validate subjectName, description
3. ‚ö†Ô∏è Document upload flow:
   - Multipart file upload (Multer)
   - File validation (size ‚â§20MB, types: .pdf/.docx/.txt)
   - MIME type validation
   - Upload to storage (local ‚Üí S3)
   - Create document record (status: Uploading)
   - Trigger ingestion job
4. ‚ö†Ô∏è Implement StorageAdapter:
   - Local storage cho dev
   - S3 integration cho prod
   - Pre-signed URL generation
5. ‚ö†Ô∏è Background jobs:
   - document.ingestion: extract text (pdf-parse, mammoth)
   - content.summary: call LLM cho t√≥m t·∫Øt
   - Update document status (Processing ‚Üí Completed/Error)
   - Error handling + retry logic
6. ‚ö†Ô∏è Document retrieval:
   - GET v·ªõi authorization (owner ho·∫∑c shared)
   - Return summary (short/full)
7. ‚ö†Ô∏è Tests:
   - Unit tests cho services
   - Integration tests cho upload flow
   - Worker job tests (happy path + errors)

**Acceptance Criteria:**
- [ ] Upload flow ho·∫°t ƒë·ªông end-to-end
- [ ] File validation prevents malicious uploads
- [ ] Text extraction cho .pdf/.docx/.txt
- [ ] Summary generation qua LLM
- [ ] Status workflow ƒë√∫ng
- [ ] Storage adapter c√≥ th·ªÉ swap (local/S3)
- [ ] Jobs c√≥ retry + DLQ
- [ ] Tests coverage ‚â•85%

---

### Module 3: Question Sets & Quiz (BE3)

**Owner:** Backend Developer 3  
**Timeline:** Tu·∫ßn 3-4

**Endpoints:**
- GET `/question-sets` - List question sets
- POST `/question-sets/generate` - Generate from document
- GET/PATCH `/question-sets/{id}` - QuestionSet operations
- POST `/question-sets/{id}/share` - Generate share link
- POST `/quiz-attempts` - Start quiz
- GET `/quiz-attempts/{id}` - Get attempt
- POST `/quiz-attempts/{id}/submit` - Submit answers

**Tasks:**
1. ‚úÖ C·∫•u tr√∫c c∆° b·∫£n ƒë√£ c√≥
2. ‚ö†Ô∏è Question generation:
   - Validate input (documentId, topics, difficulty, numQuestions)
   - Idempotency-Key support
   - Load document text
   - Build prompt cho LLM (Gemini)
   - Parse JSON response
   - Validate questions (MCQ format, 4 options, 1 correct)
   - Enforce difficultyLevel enum
   - Save to DB (status: Draft)
   - Return 201 (sync) ho·∫∑c 202 (async via job)
3. ‚ö†Ô∏è Prompt engineering:
   - Template cho Gemini API
   - Specify JSON format
   - Include difficulty levels
   - Handle parsing errors
4. ‚ö†Ô∏è QuestionSet CRUD:
   - List v·ªõi pagination + filters (userId, subjectId, status)
   - Get v·ªõi ownership/sharing check
   - Patch v·ªõi ownership (edit questions, title, status)
   - Share link: generate unique URL, store in DB
5. ‚ö†Ô∏è Quiz attempt flow:
   - POST /quiz-attempts: create attempt (startTime)
   - Store setId, userId
   - GET /quiz-attempts/{id}: return attempt (kh√¥ng leak ƒë√°p √°n)
   - POST /quiz-attempts/{id}/submit:
     - Validate ownership
     - Check not already completed
     - Score answers theo tr·ªçng s·ªë ƒë·ªô kh√≥
     - Calculate total score
     - Mark isCompleted, set endTime
     - Trigger commission record creation
6. ‚ö†Ô∏è Scoring algorithm:
   ```javascript
   const weights = {
     'Bi·∫øt': 1.0,
     'Hi·ªÉu': 1.5,
     'V·∫≠n d·ª•ng': 2.0,
     'V·∫≠n d·ª•ng cao': 2.5
   };
   
   totalWeightedScore = questions.reduce((sum, q, idx) => {
     const isCorrect = userAnswers[idx].selectedOption === q.correctOption;
     return sum + (isCorrect ? weights[q.difficultyLevel] : 0);
   }, 0);
   
   maxWeightedScore = questions.reduce((sum, q) => sum + weights[q.difficultyLevel], 0);
   
   percentageScore = (totalWeightedScore / maxWeightedScore) * 100;
   ```
7. ‚ö†Ô∏è Tests:
   - Unit tests cho scoring logic (nhi·ªÅu cases)
   - Integration tests cho generation flow
   - Mock LLM responses
   - Edge cases (empty questions, invalid difficulty)

**Acceptance Criteria:**
- [ ] Question generation qua LLM ho·∫°t ƒë·ªông
- [ ] Idempotency-Key prevents duplicates
- [ ] difficultyLevel validation enforced
- [ ] Share link generation unique
- [ ] Quiz scoring algorithm ƒë√∫ng
- [ ] Commission trigger khi submit
- [ ] Tests coverage ‚â•85%
- [ ] Compliant v·ªõi OpenAPI

---

### Module 4: Validation Workflow (BE4)

**Owner:** Backend Developer 1 ho·∫∑c 2  
**Timeline:** Tu·∫ßn 3-4

**Endpoints:**
- POST `/question-sets/{id}/review` - Request validation
- GET `/validation-requests` - List requests (Expert/Admin)
- GET `/validation-requests/{id}` - Get request detail
- PATCH `/validation-requests/{id}` - Update status (assign, complete)

**Tasks:**
1. ‚úÖ C·∫•u tr√∫c c∆° b·∫£n ƒë√£ c√≥
2. ‚ö†Ô∏è Create validation request:
   - Validate setId exists, owned by requester
   - Check no open request (PendingAssignment/Assigned) for this set
   - Create validationRequest record
   - Publish event `review.assigned`
   - Return 202 Accepted
3. ‚ö†Ô∏è List validation requests:
   - Admin: see all
   - Expert: see assigned to them
   - Learner: see their own requests
   - Pagination + filters (status, expertId)
4. ‚ö†Ô∏è Assign Expert (Admin/Auto):
   - PATCH v·ªõi status=Assigned, expertId
   - Validate Expert role
   - Send notification to Expert
5. ‚ö†Ô∏è Complete review:
   - Expert PATCH v·ªõi status=Completed, feedback
   - Update questionSet (apply edits if needed)
   - Calculate commission
   - Notify Learner
6. ‚ö†Ô∏è Unique constraint:
   - Partial index: `{ setId: 1 }` unique where `status IN ('PendingAssignment','Assigned')`
   - Handle conflict error ‚Üí 409
7. ‚ö†Ô∏è Notifications:
   - Email to Expert khi assigned
   - Email to Learner khi completed
   - In-app notifications
8. ‚ö†Ô∏è Tests:
   - Workflow tests (create ‚Üí assign ‚Üí complete)
   - Constraint tests (duplicate request)
   - Authorization tests (role checks)

**Acceptance Criteria:**
- [ ] Validation request workflow ho√†n ch·ªânh
- [ ] Unique constraint enforced
- [ ] Expert assignment ho·∫°t ƒë·ªông
- [ ] Notifications g·ª≠i ƒë√∫ng
- [ ] Commission t√≠nh khi complete
- [ ] Tests coverage ‚â•85%

---

### Module 5: Notifications & Email (BE5)

**Owner:** Backend Developer 3  
**Timeline:** Tu·∫ßn 4

**Endpoints:**
- GET `/notifications` - List user notifications
- PATCH `/notifications/{id}` - Mark as read

**Tasks:**
1. ‚úÖ C·∫•u tr√∫c c∆° b·∫£n ƒë√£ c√≥
2. ‚ö†Ô∏è Notification service:
   - Create notification record
   - Consume events (review.assigned, review.completed, quiz.completed)
   - Store in notifications collection
3. ‚ö†Ô∏è Email adapter:
   - SendGrid/SES integration
   - Email templates (HTML)
   - Template data injection
4. ‚ö†Ô∏è Email templates:
   - welcome.html
   - review.assigned.html
   - review.completed.html
   - quiz.completed.html
   - validation.approved.html
5. ‚ö†Ô∏è Background job:
   - notifications.email: send emails asynchronously
   - Retry on failure
   - Track sent status
6. ‚ö†Ô∏è Endpoints:
   - GET /notifications: pagination, filter by isRead
   - PATCH /notifications/{id}: mark as read
7. ‚ö†Ô∏è Tests:
   - Mock email service
   - Verify templates render correctly
   - Integration tests cho notification flow

**Acceptance Criteria:**
- [ ] Notifications l∆∞u v√†o DB
- [ ] Emails g·ª≠i qua SendGrid/SES
- [ ] Templates render ƒë√∫ng
- [ ] Mark as read ho·∫°t ƒë·ªông
- [ ] Tests coverage ‚â•80%

---

### Module 6: Subscriptions & Payments (BE6)

**Owner:** Backend Developer 2 ho·∫∑c 3  
**Timeline:** Tu·∫ßn 4 (optional n·∫øu c√≤n th·ªùi gian)

**Endpoints:**
- GET `/subscription-plans` - List plans
- GET `/user-subscriptions/me` - My subscriptions
- POST `/subscriptions` - Create subscription
- POST `/webhooks/stripe` - Stripe webhook

**Tasks:**
1. ‚úÖ C·∫•u tr√∫c c∆° b·∫£n ƒë√£ c√≥
2. ‚ö†Ô∏è Subscription plans:
   - Seed data (Free, Premium Monthly, Premium Yearly)
   - List endpoint (public)
3. ‚ö†Ô∏è Create subscription:
   - Validate planId
   - Create userSubscription (status: PendingPayment)
   - Create Stripe checkout session (TBC)
   - Return checkout URL
4. ‚ö†Ô∏è Stripe webhook:
   - Verify signature
   - Handle events:
     - checkout.session.completed ‚Üí update status=Active
     - invoice.payment_failed ‚Üí status=Expired
   - Update user.subscriptionStatus
5. ‚ö†Ô∏è Entitlements enforcement:
   - Check user's plan before expensive operations
   - Limits (maxValidationRequests, maxDocuments, etc.)
6. ‚ö†Ô∏è Tests:
   - Mock Stripe API
   - Webhook signature validation
   - Entitlements checks

**Acceptance Criteria:**
- [ ] Plans listing works
- [ ] Subscription creation (stub payment OK)
- [ ] Webhook handler (Stripe integration TBC)
- [ ] Entitlements enforced
- [ ] Tests coverage ‚â•80%

---

### Module 7: Commission Records (BE7)

**Owner:** Backend Developer 1  
**Timeline:** Tu·∫ßn 4

**Endpoints:**
- GET `/commission-records` - List commissions (Expert/Admin)

**Tasks:**
1. ‚úÖ C·∫•u tr√∫c c∆° b·∫£n ƒë√£ c√≥
2. ‚ö†Ô∏è Commission calculation:
   - Trigger khi quiz attempt completed
   - Formula (theo SRS):
     ```
     commission = quizAttemptPrice * commissionRate
     commissionRate = 0.7 (Expert gets 70%)
     ```
   - Create commissionRecord (status: Pending)
3. ‚ö†Ô∏è List commissions:
   - Expert: see their own records
   - Admin: see all records
   - Pagination + filters (status, expertId, dateRange)
4. ‚ö†Ô∏è Mark as Paid (Admin only):
   - PATCH endpoint to update status=Paid
5. ‚ö†Ô∏è Tests:
   - Calculation logic
   - Authorization (Expert sees own, Admin sees all)

**Acceptance Criteria:**
- [ ] Commission created khi quiz complete
- [ ] Calculation formula ƒë√∫ng
- [ ] Expert query own commissions
- [ ] Admin manage payments
- [ ] Tests coverage ‚â•85%

---

## 4. L·ªô tr√¨nh tri·ªÉn khai 4 tu·∫ßn

### üóìÔ∏è Tu·∫ßn 1: Foundation & Auth

**M·ª•c ti√™u:** Ho√†n thi·ªán h·∫° t·∫ßng c∆° b·∫£n v√† authentication flow

**BE1 (Auth & Users):**
- [ ] Implement OAuth 2.0 flow v·ªõi Google
- [ ] JWT generation v√† validation
- [ ] Refresh token mechanism
- [ ] User profile endpoints (GET/PATCH /users/me)
- [ ] Admin users endpoint
- [ ] Unit tests cho auth service

**Infrastructure:**
- [ ] Ho√†n thi·ªán error handling middleware
- [ ] ETag support cho PATCH endpoints
- [ ] Rate limiting headers
- [ ] Request logging v·ªõi correlation ID
- [ ] Input validation schemas (Joi)

**Deliverables:**
- ‚úÖ OAuth flow ho·∫°t ƒë·ªông (dev env)
- ‚úÖ JWT tokens validate ƒë√∫ng
- ‚úÖ Error responses theo format chu·∫©n
- ‚úÖ Tests coverage ‚â•90% cho auth module
- ‚úÖ Postman collection cho auth endpoints

---

### üóìÔ∏è Tu·∫ßn 2: Core Domain (Subjects & Documents)

**M·ª•c ti√™u:** Ho√†n thi·ªán qu·∫£n l√Ω t√†i li·ªáu v√† x·ª≠ l√Ω n·ªÅn

**BE2 (Subjects & Documents):**
- [ ] Subjects CRUD ho√†n ch·ªânh
- [ ] Document upload flow
- [ ] File validation v√† storage
- [ ] Text extraction worker (pdf-parse, mammoth)
- [ ] Summary generation worker (LLM)
- [ ] Status workflow implementation
- [ ] Integration tests cho upload pipeline

**Adapters:**
- [ ] StorageClient implementation (local + S3 ready)
- [ ] LLMClient prompt testing v√† optimization
- [ ] Queue/EventBus implementation (Redis)

**Deliverables:**
- ‚úÖ Upload + extraction + summary flow end-to-end
- ‚úÖ LLM integration ho·∫°t ƒë·ªông
- ‚úÖ Background jobs v·ªõi retry logic
- ‚úÖ Tests coverage ‚â•85% cho documents module
- ‚úÖ Postman collection cho subjects/documents

---

### üóìÔ∏è Tu·∫ßn 3: Question Generation & Quiz

**M·ª•c ti√™u:** Ho√†n thi·ªán t√≠nh nƒÉng c·ªët l√µi (sinh ƒë·ªÅ v√† l√†m b√†i)

**BE3 (QuestionSets & Quiz):**
- [ ] Question generation t·ª´ document
- [ ] Prompt engineering cho Gemini
- [ ] QuestionSet CRUD v·ªõi ownership
- [ ] Share link generation
- [ ] Quiz attempt flow (start/submit)
- [ ] Scoring algorithm v·ªõi tr·ªçng s·ªë
- [ ] Commission trigger
- [ ] Idempotency-Key support
- [ ] Integration tests cho full flow

**BE4 (Validation Workflow):**
- [ ] Create validation request
- [ ] Assign Expert workflow
- [ ] Review completion
- [ ] Unique constraint enforcement
- [ ] Notifications integration

**Deliverables:**
- ‚úÖ Generate ‚Üí Quiz ‚Üí Score flow ho·∫°t ƒë·ªông
- ‚úÖ Validation request workflow
- ‚úÖ LLM prompt quality t·ªët (√≠t hallucination)
- ‚úÖ Tests coverage ‚â•85% cho questionSets/quiz
- ‚úÖ E2E test scenario: upload doc ‚Üí generate ‚Üí quiz ‚Üí review

---

### üóìÔ∏è Tu·∫ßn 4: Notifications, Subscriptions & Polish

**M·ª•c ti√™u:** Ho√†n thi·ªán t√≠nh nƒÉng ph·ª• v√† polish

**BE5 (Notifications):**
- [ ] Email service integration (SendGrid/SES)
- [ ] Email templates
- [ ] Notification endpoints
- [ ] Background email jobs

**BE6 (Subscriptions - optional):**
- [ ] Subscription plans listing
- [ ] Create subscription
- [ ] Stripe checkout (stub/real)
- [ ] Webhook handler
- [ ] Entitlements enforcement

**BE7 (Commission Records):**
- [ ] Commission calculation
- [ ] List commissions endpoint
- [ ] Admin payment tracking

**Polish:**
- [ ] Security audit (input validation, file upload)
- [ ] Performance optimization (indexes, queries)
- [ ] API documentation (Swagger/OpenAPI UI)
- [ ] Error messages i18n ready
- [ ] Logging improvements
- [ ] Health check endpoint n√¢ng cao

**Deliverables:**
- ‚úÖ T·∫•t c·∫£ endpoints theo OpenAPI spec
- ‚úÖ Email notifications ho·∫°t ƒë·ªông
- ‚úÖ Subscriptions (basic flow)
- ‚úÖ Commission tracking
- ‚úÖ Overall tests coverage ‚â•85%
- ‚úÖ API documentation live
- ‚úÖ Production-ready checklist completed

---

## 5. Ti√™u ch√≠ nghi·ªám thu (DoD)

### ‚úÖ Definition of Done (m·ªói endpoint)

**Functional:**
- [ ] Implementation kh·ªõp OpenAPI spec (paths, params, status codes, schemas)
- [ ] Business logic ƒë√∫ng theo SRS/SDD
- [ ] Authorization checks (JWT + RBAC + ownership)
- [ ] Input validation v·ªõi Joi schemas
- [ ] Error handling v·ªõi format chu·∫©n `{ code, message, details }`
- [ ] Pagination cho list endpoints `{ items, meta }`
- [ ] ETag/If-None-Match cho update endpoints (n·∫øu applicable)
- [ ] Idempotency-Key cho creation endpoints (n·∫øu applicable)

**Non-Functional:**
- [ ] Response time < 2s cho sync operations
- [ ] Background jobs < 5 ph√∫t (extraction/summary/generation)
- [ ] Rate limiting headers (X-RateLimit-*)
- [ ] Request logging v·ªõi requestId + userId
- [ ] Graceful error handling (no crashes)

**Quality:**
- [ ] Unit tests coverage ‚â•85%
- [ ] Integration tests cho happy path
- [ ] Edge cases covered (invalid input, not found, forbidden)
- [ ] Code review passed
- [ ] ESLint no errors
- [ ] No console.log (use logger)

**Documentation:**
- [ ] Inline JSDoc cho public methods
- [ ] Postman/Thunder collection updated
- [ ] README updated (n·∫øu c√≥ thay ƒë·ªïi l·ªõn)

---

### ‚úÖ Definition of Done (module)

**All endpoints complete:**
- [ ] T·∫•t c·∫£ endpoints trong module pass DoD
- [ ] Integration tests cho module flow
- [ ] Contract tests verify OpenAPI compliance

**Database:**
- [ ] Mongoose schemas c√≥ validators/enums
- [ ] Indexes ƒë∆∞·ª£c khai b√°o (user-scoped, status, unique)
- [ ] Migration script (n·∫øu c·∫ßn seed data)

**Security:**
- [ ] No SQL/NoSQL injection vulnerabilities
- [ ] File upload security (size, type, MIME validation)
- [ ] Secrets kh√¥ng hardcoded
- [ ] CORS configured properly

**Performance:**
- [ ] Queries optimized (use indexes)
- [ ] N+1 query avoided
- [ ] Pagination implemented
- [ ] Background jobs cho heavy operations

---

### ‚úÖ Definition of Done (MVP v0.1)

**All modules complete:**
- [ ] T·∫•t c·∫£ 7 modules pass module DoD
- [ ] E2E tests cho critical flows:
  - OAuth login ‚Üí create subject ‚Üí upload doc ‚Üí generate questions ‚Üí take quiz ‚Üí request review
- [ ] Performance testing (basic load test)
- [ ] Security audit completed

**Deployment Ready:**
- [ ] Environment variables documented
- [ ] Database indexes created
- [ ] Seed data script (subscription plans, demo users)
- [ ] Health check endpoint functional
- [ ] Graceful shutdown implemented
- [ ] Logs to stdout (container-friendly)

**Documentation:**
- [ ] API documentation live (Swagger UI)
- [ ] Postman collection complete
- [ ] README with setup instructions
- [ ] Architecture diagrams updated
- [ ] Deployment guide (TBC)

**Quality Metrics:**
- [ ] Overall test coverage ‚â•85%
- [ ] No critical security vulnerabilities
- [ ] No P0/P1 bugs
- [ ] All OpenAPI endpoints implemented

---

## 6. R·ªßi ro v√† gi·∫£i ph√°p

### üî¥ R·ªßi ro cao

#### 1. LLM API cost/quota v∆∞·ª£t ng√¢n s√°ch

**M√¥ t·∫£:** Gemini API c√≥ th·ªÉ t·ªën ph√≠ ho·∫∑c b·ªã rate limit

**Gi·∫£i ph√°p:**
- Implement quota tracking
- Cache k·∫øt qu·∫£ generation (avoid regenerate)
- Throttle requests (queue system)
- Dev/test d√πng LLM_MODE=stub
- Monitor usage daily

**Owner:** BE2, BE3

---

#### 2. Text extraction ch·∫•t l∆∞·ª£ng th·∫•p (PDF ph·ª©c t·∫°p)

**M√¥ t·∫£:** pdf-parse kh√¥ng parse ƒë∆∞·ª£c PDF scan/OCR/images

**Gi·∫£i ph√°p:**
- Document preprocessing (check if scanned)
- Fallback to OCR service (Tesseract/Google Vision - TBC)
- Clear error message cho user
- Support plain text upload (.txt) as alternative
- Limit file size 20MB

**Owner:** BE2

---

#### 3. Question generation hallucination/sai n·ªôi dung

**M√¥ t·∫£:** LLM t·∫°o c√¢u h·ªèi sai ho·∫∑c kh√¥ng li√™n quan

**Gi·∫£i ph√°p:**
- Prompt engineering careful (include context, format)
- Validation workflow (Expert review required)
- User report feature (flag bad questions)
- A/B test prompts
- Fallback to template-based generation (TBD)

**Owner:** BE3

---

### üü° R·ªßi ro trung b√¨nh

#### 4. OAuth integration ph·ª©c t·∫°p (dev/prod env kh√°c nhau)

**M√¥ t·∫£:** Google OAuth callback URLs, credentials kh√°c nhau

**Gi·∫£i ph√°o:**
- T√°ch config theo env (dev/staging/prod)
- Use AUTH_MODE=stub cho local dev
- Document OAuth setup clearly
- Test integration early

**Owner:** BE1

---

#### 5. Mongoose schema changes breaking data

**M√¥ t·∫£:** Schema changes c√≥ th·ªÉ l√†m h·ªèng d·ªØ li·ªáu c≈©

**Gi·∫£i ph√°p:**
- Migration scripts cho schema changes
- Backward compatibility khi possible
- Seed data script ƒë·ªÉ recreate clean DB
- Backup before migration (prod)

**Owner:** All

---

#### 6. Background jobs fail silently

**M√¥ t·∫£:** Worker jobs fail nh∆∞ng kh√¥ng notify

**Gi·∫£i ph√°o:**
- Implement DLQ (Dead Letter Queue)
- Job status tracking in DB
- Alert/notification khi job fail nhi·ªÅu l·∫ßn
- Retry with exponential backoff
- Admin dashboard for job monitoring (TBD)

**Owner:** BE2, BE3, BE5

---

### üü¢ R·ªßi ro th·∫•p

#### 7. File upload security

**M√¥ t·∫£:** Malicious file upload

**Gi·∫£i ph√°p:**
- MIME type validation
- File extension whitelist (.pdf/.docx/.txt only)
- Size limit 20MB
- Virus scan (ClamAV integration - optional)
- Store uploads isolated (S3 bucket)

**Owner:** BE2

---

#### 8. Rate limiting too strict

**M√¥ t·∫£:** Legitimate users b·ªã block

**Gi·∫£i ph√°p:**
- Configurable rate limits per endpoint
- Higher limits for premium users
- Whitelist admin/internal IPs
- Monitor rate limit hits
- Clear error messages (Retry-After header)

**Owner:** BE1

---

## 7. Checklist t·ªïng h·ª£p

### üì¶ Module Completion

- [ ] **BE1: Auth & Users** (Tu·∫ßn 1-2)
  - [ ] OAuth 2.0 flow
  - [ ] JWT validation
  - [ ] Refresh tokens
  - [ ] User profile (GET/PATCH)
  - [ ] Admin user management
  - [ ] Tests ‚â•90%

- [ ] **BE2: Subjects & Documents** (Tu·∫ßn 2)
  - [ ] Subjects CRUD
  - [ ] Document upload
  - [ ] Text extraction (pdf/docx/txt)
  - [ ] Summary generation (LLM)
  - [ ] Background jobs
  - [ ] Tests ‚â•85%

- [ ] **BE3: QuestionSets & Quiz** (Tu·∫ßn 3)
  - [ ] Question generation (LLM)
  - [ ] QuestionSet CRUD
  - [ ] Share links
  - [ ] Quiz attempts
  - [ ] Scoring algorithm
  - [ ] Tests ‚â•85%

- [ ] **BE4: Validation Workflow** (Tu·∫ßn 3-4)
  - [ ] Create validation request
  - [ ] Assign Expert
  - [ ] Review completion
  - [ ] Notifications
  - [ ] Tests ‚â•85%

- [ ] **BE5: Notifications** (Tu·∫ßn 4)
  - [ ] In-app notifications
  - [ ] Email service integration
  - [ ] Email templates
  - [ ] Background email jobs
  - [ ] Tests ‚â•80%

- [ ] **BE6: Subscriptions** (Tu·∫ßn 4 - optional)
  - [ ] Plans listing
  - [ ] Create subscription
  - [ ] Stripe integration (basic)
  - [ ] Webhook handler
  - [ ] Tests ‚â•80%

- [ ] **BE7: Commission Records** (Tu·∫ßn 4)
  - [ ] Commission calculation
  - [ ] List commissions
  - [ ] Admin tracking
  - [ ] Tests ‚â•85%

---

### üß™ Testing

- [ ] Unit tests ‚â•85% overall coverage
- [ ] Integration tests cho critical flows
- [ ] E2E test: full user journey
- [ ] Contract tests (OpenAPI compliance)
- [ ] Load testing (basic)
- [ ] Security testing (OWASP top 10)

---

### üîí Security

- [ ] JWT validation on all protected endpoints
- [ ] RBAC enforcement
- [ ] Ownership checks
- [ ] Input validation (Joi schemas)
- [ ] File upload security
- [ ] CORS configured
- [ ] Helmet middleware
- [ ] Secrets in env vars (not hardcoded)
- [ ] Rate limiting
- [ ] SQL/NoSQL injection prevention

---

### üìä Database

- [ ] All Mongoose models complete
- [ ] Validators/enums in schemas
- [ ] Indexes declared (user-scoped, status, unique)
- [ ] Timestamps enabled
- [ ] ETag/version keys (__v)
- [ ] Unique constraints (email, sharedUrl)
- [ ] Partial indexes (validationRequests)
- [ ] Seed data script

---

### üöÄ Deployment

- [ ] Environment variables documented
- [ ] Config for dev/staging/prod
- [ ] Health check endpoint
- [ ] Graceful shutdown
- [ ] Logging to stdout
- [ ] Error monitoring setup (TBD)
- [ ] Docker container (optional)
- [ ] CI/CD pipeline (optional)

---

### üìö Documentation

- [ ] API documentation (Swagger UI)
- [ ] Postman collection complete
- [ ] README updated
- [ ] Architecture diagrams
- [ ] Deployment guide
- [ ] Troubleshooting guide
- [ ] Environment setup guide

---

### ‚úÖ Quality Gates

- [ ] ESLint no errors
- [ ] Prettier formatted
- [ ] No console.log (use logger)
- [ ] Tests pass in CI
- [ ] Code review approved
- [ ] No P0/P1 bugs
- [ ] Security audit passed
- [ ] Performance benchmarks met

---

## üìù Notes

### Development Mode Flags

ƒê·ªÉ h·ªó tr·ª£ ph√°t tri·ªÉn song song kh√¥ng ph·ª• thu·ªôc:

```bash
# Auth
AUTH_MODE=stub|real          # Stub: use X-Dev-User-Id header, Real: verify JWT

# Database
DB_MODE=memory|mongo         # Memory: in-memory DB for tests, Mongo: real connection

# LLM
LLM_MODE=stub|real          # Stub: mock responses, Real: call Gemini API

# Storage
STORAGE_MODE=local|s3       # Local: filesystem, S3: AWS S3

# Queue
QUEUE_MODE=stub|real        # Stub: in-memory queue, Real: Redis/RabbitMQ

# Email
EMAIL_MODE=stub|real        # Stub: log only, Real: send via SendGrid/SES

# Payment
PAYMENT_MODE=stub|real      # Stub: always succeed, Real: Stripe integration
```

### Stub Mode Testing

Khi `AUTH_MODE=stub`, accept headers:
- `X-Dev-User-Id`: user ID
- `X-Dev-User-Role`: Learner|Expert|Admin

Example:
```bash
curl -H "X-Dev-User-Id: 60d5ec49f1b2c8b1f8e4e1a1" \
     -H "X-Dev-User-Role: Admin" \
     http://localhost:3000/api/v1/admin/users
```

### Priority Order

1. **P0 (Critical):** Auth, Documents Upload, Question Generation, Quiz Scoring
2. **P1 (High):** Validation Workflow, Notifications, Subscriptions
3. **P2 (Medium):** Commission Records, Admin features
4. **P3 (Low):** Nice-to-haves, optimizations

### Success Metrics

- **Functional:** 100% OpenAPI endpoints implemented
- **Quality:** ‚â•85% test coverage
- **Performance:** <2s response time for sync APIs
- **Security:** 0 critical vulnerabilities
- **Documentation:** 100% endpoints documented

---

## üéØ K·∫øt lu·∫≠n

K·∫ø ho·∫°ch n√†y cung c·∫•p l·ªô tr√¨nh chi ti·∫øt ƒë·ªÉ ho√†n thi·ªán backend Learinal MVP v0.1 trong 4 tu·∫ßn. 

**Key principles:**
- ‚úÖ Tu√¢n th·ªß OpenAPI spec
- ‚úÖ Chu·∫©n h√≥a error responses
- ‚úÖ RBAC + ownership checks
- ‚úÖ Background jobs cho heavy operations
- ‚úÖ Tests coverage ‚â•85%
- ‚úÖ Stub mode cho ph√°t tri·ªÉn ƒë·ªôc l·∫≠p

**Critical path:**
Auth ‚Üí Documents ‚Üí Questions ‚Üí Quiz ‚Üí Validation

**Team allocation:**
- BE1: Auth, Users, Commission, Infrastructure
- BE2: Subjects, Documents, Storage, Workers
- BE3: QuestionSets, Quiz, Notifications

V·ªõi k·∫ø ho·∫°ch n√†y, team c√≥ th·ªÉ ph√°t tri·ªÉn song song v√† t√≠ch h·ª£p d·∫ßn, ƒë·∫£m b·∫£o deliver ƒë√∫ng timeline v√† ch·∫•t l∆∞·ª£ng.

---

**Ng∆∞·ªùi duy·ªát:** _____________________  
**Ng√†y duy·ªát:** _____________________
